var r=class{constructor(e={}){this.config={uploadUrl:"/grapesjs/media",fetchUrl:"/grapesjs/media",...e},this.editor=null}init(e){this.editor=e,this.loadAssets()}getConfig(){return{upload:this.config.uploadUrl,autoAdd:!0,assets:[],uploadFile:e=>this.handleFileUpload(e)}}handleFileUpload(e){if(!this.editor){console.error("Editor not initialized");return}let i=e.dataTransfer?e.dataTransfer.files:e.target.files,o=new FormData;for(let t=0;t<i.length;t++)o.append("files[]",i[t]);fetch(this.config.uploadUrl,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:o}).then(t=>{if(!t.ok)throw new Error("Upload failed");return t.json()}).then(t=>{Array.isArray(t)?t.forEach(s=>{this.editor.AssetManager.add(s)}):this.editor.AssetManager.add([t])}).catch(t=>console.error("Error:",t))}loadAssets(){if(!this.editor){console.error("Editor not initialized");return}fetch(this.config.fetchUrl).then(e=>{if(!e.ok)throw new Error("Failed to fetch assets");return e.json()}).then(e=>{Array.isArray(e)&&this.editor.AssetManager.add(e)}).catch(e=>console.error("Error:",e))}};var l=class{constructor(e){this.editor=e,this.originalCodeViewHtml=null,this.filteredCodeViewHtml=null,this.initialize()}initialize(){this.registerComponentType(),this.setupEventListeners(),this.overrideCodeCommand()}registerComponentType(){this.editor.Components.addType("non-editable",{model:{defaults:{editable:!1,draggable:!1,droppable:!1,copyable:!1,removable:!1,highlightable:!1,selectable:!1}},view:{events:{click:e=>e.stopPropagation(),dblclick:e=>e.stopPropagation(),mousedown:e=>e.stopPropagation()},onRender({el:e}){e.style.pointerEvents="none",e.style.opacity="0.8"}}})}setupEventListeners(){this.editor.on("load",()=>this.processNonEditableComponents()),this.editor.on("component:update",e=>{e.getClasses().includes("gjs-non-editable")&&this.applyNonEditableProperties(e)}),this.editor.on("component:add",e=>{e.getClasses().includes("gjs-non-editable")&&this.applyNonEditableProperties(e)}),this.editor.on("codeEdit:before",()=>{this.originalCodeViewHtml=this.editor.getHtml();let e=this.editor.getHtml();e=this.removeNonEditableComponentsFromHtml(e),this.filteredCodeViewHtml=e,this.editor.setCustomCode(e)}),this.editor.on("codeEdit:after",()=>{if(this.originalCodeViewHtml){let e=this.editor.getCustomCode();this.filteredCodeViewHtml===e&&this.editor.DomComponents.getWrapper().set("content",this.originalCodeViewHtml),this.originalCodeViewHtml=null,this.filteredCodeViewHtml=null}})}overrideCodeCommand(){this.editor.Commands.add("open-code",{run:(e,i)=>{let o=e.getHtml(),t=document.createElement("div");t.innerHTML=o,t.querySelectorAll(".gjs-non-editable").forEach(a=>a.parentNode.removeChild(a));let n=t.innerHTML;e._filteredCodeViewHtml=n,e._originalCodeViewHtml=o,e.Modal.open({title:"Code Editor",content:`<textarea style="width:100%; height:250px;">${n}</textarea>`,attributes:{class:"gjs-modal-code"}})}})}applyNonEditableProperties(e){e.set({type:"non-editable",editable:!1,draggable:!1,droppable:!1,copyable:!1,removable:!1,highlightable:!1,selectable:!1}),e.addAttributes({"data-gjs-locked":!0});let i=e.getEl();i&&(i.style.pointerEvents="none",i.style.opacity="0.8")}processNonEditableComponents(){this.editor.Components.getWrapper().find("*").forEach(i=>{i.getClasses().includes("gjs-non-editable")&&this.applyNonEditableProperties(i)})}removeNonEditableComponentsFromHtml(e){let i=document.createElement("div");i.innerHTML=e;let o=i.getElementsByClassName("gjs-non-editable");return Array.from(o).forEach(t=>t.parentNode.removeChild(t)),i.innerHTML}};document.addEventListener("alpine:init",()=>{Alpine.data("grapesjs",({state:d,statePath:e,readOnly:i,tools:o,minHeight:t,container:s})=>({editor:null,initialContent:d,toolsConfig:o,nonEditableManager:null,assetManager:null,init(){this.initializeEditor(),this.setupContentHandling()},initializeEditor(){this.assetManager=new r({uploadUrl:"/grapesjs/media",fetchUrl:"/grapesjs/media"}),this.editor=grapesjs.init({height:t+"px",container:s||".filament-grapesjs .grapesjs-wrapper",showOffsets:!0,fromElement:!0,noticeOnUnload:!1,storageManager:!1,loadHtml:this.initialContent,panels:{defaults:[{buttons:[{attributes:{title:"Open Code"},className:"fa fa-code",command:"open-code",id:"open-code"}],id:"views"}]},plugins:["grapesjs-tailwind","grapesjs-preset-webpage","grapesjs-component-code-editor","grapesjs-custom-code"],assetManager:this.assetManager.getConfig()}),this.nonEditableManager=new l(this.editor),this.assetManager.init(this.editor)},setupContentHandling(){this.editor.on("update",()=>{let n=this.editor.getHtml({cleanId:!0}),a=n.match(/<body\b[^>]*>([\s\S]*?)<\/body>/),h=a?a[1]:n,p=this.nonEditableManager.removeNonEditableComponentsFromHtml(h);this.initialContent=p.trim()})}}))});
